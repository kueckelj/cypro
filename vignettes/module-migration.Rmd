---
title: "Module: Cellular Migration"
output: 
   html_document:
    df_print: paged
    toc: true
    toc_depth: 3
---

```{r folding, include = F}

hooks = knitr::knit_hooks$get()

hook_foldable = function(type) {
  force(type)
  function(x, options) {
    res = hooks[[type]](x, options)
    
    if (isFALSE(options[[paste0("fold.", type)]])) return(res)
    
    paste0(
      "<details><summary>", type, "</summary>\n\n",
      res,
      "\n\n</details>"
    )
  }
}

knitr::knit_hooks$set(
  output = hook_foldable("output"),
  plot = hook_foldable("plot")
)

```

```{r setup, include = F}

knitr::opts_chunk$set(echo = T, fold.output = F, fold.plot = F, fig.show = "hold", out.width = "100%", warning = F, message = F)

devtools::load_all()
library(tidyverse)

object <- readRDS(file = "data/example-tracks.RDS")

#saveCelltracerObject(object)

```

## 1. Introduction 

If the experiment design contains timelapse imaging and the data contains x- and y-coordinates you can make use of `cypro`s migration module - a collection of analysis and plotting functions to quantify cellular migration. This tutorial guides you through all of them. 

```{r setup-vis, eval = F, echo = T}

# load packages
library(cypro)
library(tidyverse)

# load object that contains tracking data 
object <- readRDS(file = "data/example-tracks.RDS")

object

```

```{r object-overview, eval = T, echo = F}

object

```

The experiment design of the example *cypro* object contains two phases as the treatment started after the 17th frame. The well plate design looked like this. 

```{r plot-well-plate, fig.cap = "Figure 1.1 Well plate design of example cypro object."}

plotWellPlate(object, size_well = 6, display_labels = F) + legendTop()

```


## 2. Computed data variables

If x- and y-coordinates are provided in the loaded data files several migration related variables are computed based on them.

### 2.1 Track data

This includes all data variables the CellTracker [output](http://www.celltracker.website/about-celltracker.html) contains: 

- Distance from origin, where for each cell the origin is the position of the cell in the first frame. (variable name: *dfo*)
- Distance from last point (variable name: *dflp*)
- Instantaneous speed, defined as the distance from the last point divided by the time elapsed between the acquisition frames (variable name: *speed*)

Assuming the data input files only contained x- and y-coordinates the respective track data.frame looks like this: 

```{r track-df}

getTracksDf(object, phase = "all", with_grouping = FALSE)

```

### 2.2 Statistic data

All three track variables are summarized in the statistic slot: 

```{r stat-df}

getStatsDf(object, with_grouping = FALSE, phase = 1) 
  

```

Two additional statistic variables are computed:

- The total distance a cell has traveled, computed by summing up all values of the variable *distance from last point* (variable name: *total_dist*)
- Migration efficiency, a measure that describes a directed a track has been computed by dividing the distance between first point and last point through the total distance. (variable name: *mgr_eff*)

Hint: Both variables rely on the distance from last point. If a cell has any missing values in that variable due to poor imaging coverage this results in *mgr_eff* and *total_dist* being summarized to `NA`. Use `cypro`s [imputation](coming-soon.html) functionalities for that matter.

## 3. Plotting

The migration module comes with functions that allow to visualize to most common graphics in cellular migration analysis. 

### 3.1 Migration plots (rose plots)

Migration plots scale down the x- and y-coordinates of all cells to a common starting position. They are often referred to as *rose plots* as the resulting spread of tracks in all direction resembles a rose. These plots can be created with the function `plotAllTracks()`.

```{r plot-all-tracks,fig.cap = "Figure 3.1 Migration plot spanning the whole experiment."}

plotAllTracks(object, across = "condition", phase = "all", nrow = 1) + legendTop()

```
In this example the treatment started at the 18th image which is why the results are best visualized by separating the tracks by phase. 

```{r plot-all-tracks-by-phase, out.width = "50%",  fig.cap = "Figure 3.2 Migration plot by phase uncovers the severe effect that the combination of LY34 and TMZ has on cellular migration capacities."}

plotAllTracks(object, across = "condition", phase = 1, nrow = 2)

plotAllTracks(object, across = "condition", phase = 2, nrow = 2)

```


### 3.2 Single tracks

In case you are interested in the migration path of single cell ids and you have there cell IDs as a character vector you can visualize them via `plotSingleTracks()`. 

```{r filter-eff-cells, collapse = T, out.width = "50%", fig.cap = "Figure 3.3 Visualization of complete track shows efficient migration (left) and inefficient migration that ended where it started (right)." }

# e.g. use tidyverse filtering style to filter for cell ids with certain characteristics
max_eff <- getCellIds(object, mgr_eff == max(mgr_eff), phase = 1)

min_eff <- getCellIds(object, mgr_eff == min(mgr_eff), phase = 1)

max_eff
min_eff


plotSingleTracks(object, cell_ids = max_eff, phase = 1) 

plotSingleTracks(object, cell_ids = min_eff[1], phase = 1)

```

### 3.3 Cellular velocity 

The speed with which cells move at given points of time is a popular measure in migration analysis. Using lineplots you can visualize the gradual change of speed within groups along a defined time span. 

```{r velocity lineplot, fig.cap = "Figure 3.4 Visualization of migrational activity over time."}

plotTimeLineplot(object,
                 variables = "speed",
                 summarize_with = "mean",
                 across = "condition",
                 display_vline = TRUE,  # highlight treatment start
                 phase = c(1,2)
                 ) + 
  legendBottom()

```

Using a heatmap preserves more resolution as every row of the heatmap can represent a cell while the lines slope is now represented by the change in color. 

```{r velocity-heatmap,fig.cap = "Figure 3.5 Visualization of migrational activity over time in heatmap."}

plotTimeHeatmap(object,
                variable = "speed",
                across = "condition",
                arrange_rows = FALSE,
                verbose = FALSE, # no progress bar 
                phase = c(1,2))

```

