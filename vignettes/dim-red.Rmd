---
title: "Dimensional Reduction"
output: 
   html_document:
    df_print: paged
---

```{r folding, include = F}

hooks = knitr::knit_hooks$get()

hook_foldable = function(type) {
  force(type)
  function(x, options) {
    res = hooks[[type]](x, options)
    
    if (isFALSE(options[[paste0("fold.", type)]])) return(res)
    
    paste0(
      "<details><summary>", type, "</summary>\n\n",
      res,
      "\n\n</details>"
    )
  }
}

knitr::knit_hooks$set(
  output = hook_foldable("output")
)

```

```{r setup, include = F}

knitr::opts_chunk$set(echo = T, fold.output = T)

devtools::load_all()

object <- readRDS(file = "data/bids-week4.RDS")
object_tracks <- readRDS(file = "data/example-tracks.RDS")

#savecyproObject(object)
#object <- renameGroups(object, "hcl_euclidean_complete_k_5_(intensity)", "low" = "1", "low_medium" = "2", "medium" = "3", "medium_high" = "4", "high" = "5")

```

## Prerequisites

Make sure to be familiar with the following tutorials before proceeding: 

- [Variable Sets](variable-sets.html)


## 1. Introduction

Dimensional reduction is an important step in visualizing the heterogeneity of your data. In **cypro** it is conducted based on variable sets. It explains how you can conduct Principal Component Analysis, TSNE and UMAP reductions and visualize the results. 

```{r setup-vis, eval = F, echo = T}

# load packages
library(cypro)

# load object from broad institute compound profiling experiment week 4
# contains one time imaging data
object <- readRDS(file = "data/bids-week4.RDS")

```


## 2. Computation 

A set of intensity related variables will serve as an example.

```{r example-vset, fold.output = T}

# show variables of a previously defined variable set
getVariableSet(object, variable_set = "intensity")

```

There is a function for every algorithm respectively. `runPca()`, `runTsne()` and `runUmap()`.

```{r runDimReds, eval = F}

object <- runPca(object, variable_set = "intensity")

object <- runUmap(object, variable_set = "intensity")


```

Dimensional reduction is part of the overall analys module in **cypro**. Use `printAnalysisSummary()` to get an overview about the dimensional reduction you have calculated for the variable sets in your *cypro* object. 

```{r printAnalysisSummary-dimred}

# tsne is missing as it hasn't been computed yet
printAnalysisSummary(object, slots = "dim_red")

```


## 3. Visualisation 

Again, there is a function for every algorithm respectively. They come with a variety of options with which you can tweak the plots.

```{r plot-pca, fig.show = "hold", out.width = "50%", fig.cap= "Figure 1.1 Visualization of PCA based on the variable set 'intensity'"}

plotPca(object, 
        variable_set = "intensity", 
        color_by = "condition",
        pt_size = 1)

plotPca(object, 
        variable_set = "intensity", 
        color_by = "Intensity_MaxIntensity_Actin", 
        pt_size = 1)

```


```{r plot-u, fig.show = "hold",  out.width = "50%", fig.cap = "Figure 1.2 Visualization of UMAP embedding based on the variable set 'intensity'"}

plotUmap(object, 
         variable_set = "intensity", 
         color_by = "condition", 
         pt_size = 1, 
         nrow = 1)

plotUmap(object, 
         variable_set = "intensity", 
         color_by = "kmeans_Hartigan.Wong_k_4_(intensity)", 
         pt_size = 1, 
         nrow = 1) 

```

## 4. Extraction 

Dimensional reduction is stored in the `@analysis`-slot under `$dim_red`. Every dimensional reduction for every variable set is stored in a specific S4-object as programmed in the package [`confuns`](https://github.com/kueckelj/confuns/blob/master/R/dimensional-reduction.R) called *dim_red_conv*. Use the respective function `getPcaConv()`, `getTsneConv()`, `getUmapConv()` to extract the S4-objects containing all data needed to proceed with the analysis on your own terms. 